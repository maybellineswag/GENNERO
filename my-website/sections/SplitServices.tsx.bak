'use client';
import React, { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import Image from 'next/image';

interface SplitServicesProps {
  height?: string;
  clickToExpand?: boolean;
}

export default function SplitServices({ height = 'h-[70vh] md:h-[80vh]', clickToExpand = false }: SplitServicesProps) {
  // State for card expansion animation
  const [hoveredSide, setHoveredSide] = useState<'gynecology' | 'cosmetology' | null>(null);
  const [expandedSide, setExpandedSide] = useState<'gynecology' | 'cosmetology' | null>(null);
  const [selectedCardIndex, setSelectedCardIndex] = useState<number | null>(null);
  const [selectedSubcategoryIndex, setSelectedSubcategoryIndex] = useState<number | null>(null);
  const [expandingCardIndex, setExpandingCardIndex] = useState<number | null>(null);
  const [cardPosition, setCardPosition] = useState<{ x: number; y: number; width: number; height: number } | null>(null);
  const [isExpanding, setIsExpanding] = useState(false);
  const cardRefs = useRef<(HTMLDivElement | null)[]>([]);
  const expandingOverlayRef = useRef<HTMLDivElement | null>(null);

  // Check URL hash on mount and when it changes to auto-expand sections and select cards
  useEffect(() => {
    const checkHash = () => {
      const hash = window.location.hash;
      
      const gynecologyCardMap: Record<string, number> = {
        '#tehotne': 0,
        '#ambulantni-gynekologie': 1,
        '#esteticka-gynekologie': 2,
        '#prevence': 3,
      };

      const cosmetologyCardMap: Record<string, number> = {
        '#elektro-epilace': 0,
        '#mikrojehlickovani': 1,
        '#chemicky-peeling': 2,
      };

      if (hash === '#gynekologie' || hash === '#gynekology') {
        setExpandedSide('gynecology');
        setHoveredSide(null);
        setSelectedCardIndex(null);
      } else if (hash === '#kosmetologie' || hash === '#cosmetology') {
        setExpandedSide('cosmetology');
        setHoveredSide(null);
        setSelectedCardIndex(null);
      } else if (gynecologyCardMap[hash] !== undefined) {
        setExpandedSide('gynecology');
        setHoveredSide(null);
        setSelectedCardIndex(gynecologyCardMap[hash]);
      } else if (cosmetologyCardMap[hash] !== undefined) {
        setExpandedSide('cosmetology');
        setHoveredSide(null);
        setSelectedCardIndex(cosmetologyCardMap[hash]);
      }
    };

    checkHash();
    window.addEventListener('hashchange', checkHash);
    return () => {
      window.removeEventListener('hashchange', checkHash);
    };
  }, []);

  // Handle card expansion animation
  useEffect(() => {
    if (isExpanding && cardPosition && expandingCardIndex !== null && selectedCardIndex !== null && expandingOverlayRef.current) {
      const timer = setTimeout(() => {
        const container = document.querySelector(`[data-expanded-card="${selectedCardIndex}"]`) as HTMLElement;
        if (container && expandingOverlayRef.current) {
          const rect = container.getBoundingClientRect();
          const scrollY = window.scrollY || window.pageYOffset;
          const scrollX = window.scrollX || window.pageXOffset;
          
          expandingOverlayRef.current.style.left = `${rect.left + scrollX}px`;
          expandingOverlayRef.current.style.top = `${rect.top + scrollY}px`;
          expandingOverlayRef.current.style.width = `${rect.width}px`;
          expandingOverlayRef.current.style.height = `${rect.height}px`;
        }
      }, 50);

      return () => clearTimeout(timer);
    }
  }, [isExpanding, cardPosition, expandingCardIndex, selectedCardIndex]);

  // Clean up expanding state
  useEffect(() => {
    if (isExpanding && selectedCardIndex !== null) {
      const timer = setTimeout(() => {
        setIsExpanding(false);
        setExpandingCardIndex(null);
        setCardPosition(null);
      }, 750);
      return () => clearTimeout(timer);
    }
  }, [isExpanding, selectedCardIndex]);

  const handleCardClick = (index: number, element: HTMLDivElement) => {
    const rect = element.getBoundingClientRect();
    const scrollY = window.scrollY || window.pageYOffset;
    const scrollX = window.scrollX || window.pageXOffset;
    
    setCardPosition({
      x: rect.left + scrollX,
      y: rect.top + scrollY,
      width: rect.width,
      height: rect.height
    });
    setExpandingCardIndex(index);
    setIsExpanding(true);
    
    setTimeout(() => {
      setSelectedCardIndex(index);
    }, 10);
  };

  const handleCardClose = () => {
    if (selectedSubcategoryIndex !== null) {
      setSelectedSubcategoryIndex(null);
    } else if (selectedCardIndex !== null) {
      setIsExpanding(true);
      setTimeout(() => {
        setSelectedCardIndex(null);
        setIsExpanding(false);
        setExpandingCardIndex(null);
        setCardPosition(null);
      }, 100);
    }
  };

  // Rest of the component code will be added...
  return <div>Component restored - please check the full file</div>;
}
